<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f9fafb; }
        .theme-purple-bg { background-color: #f5f3ff; }
        .theme-purple-text { color: #6d28d9; }
        .theme-purple-border { border-color: #ddd6fe; }
        .now-line { position: absolute; top: 0; bottom: 0; width: 3px; background-color: #ef4444; border-radius: 99px; box-shadow: 0 0 8px rgba(239, 68, 68, 0.7); z-index: 10; transition: left 1s linear; }
        .now-label { position: absolute; top: -22px; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 500; z-index: 10; }
        .task-card { transition: all 0.15s ease-in-out, opacity 0.3s ease, transform 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .task-card.is-done { opacity: 0.6; }
        .task-card.is-done .task-title { text-decoration: line-through; color: #6b7280; }
        .companion-corner:hover .companion-bubble { opacity: 1; transform: translateY(0) scale(1); }
        .companion-bubble { opacity: 0; transform: translateY(10px) scale(0.95); transition: all 0.2s ease-out; pointer-events: none; }
        .companion-corner:hover .companion-bubble { pointer-events: auto; }
        .timer-modal, .view-container { transition: opacity 0.2s ease-in-out; }
        .fade-out { opacity: 0; transform: scale(0.95); }
        .nav-btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; color: #4b5563; transition: all 0.2s ease; }
        .nav-btn.active { color: #6d28d9; background-color: #f5f3ff; }
        .calendar-day { min-height: 100px; transition: background-color 0.2s; cursor: pointer; }
        .calendar-day:hover { background-color: #f5f3ff; }
        .task-dot { width: 6px; height: 6px; background-color: #8b5cf6; border-radius: 50%; }
        .badge { position: relative; transition: transform 0.2s ease; }
        .badge:hover { transform: scale(1.05); }
        .badge .badge-tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s ease; }
        .badge:hover .badge-tooltip { visibility: visible; opacity: 1; }
        .badge-count { position: absolute; top: -5px; right: -5px; background-color: #8b5cf6; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
        .task-block { position: absolute; top: 0; height: 100%; background-color: rgba(139, 92, 246, 0.2); border-left: 2px solid #8b5cf6; padding-left: 4px; font-size: 10px; color: #5b21b6; overflow: hidden; white-space: nowrap; }
    </style>
</head>
<body class="p-4 md:p-8 antialiased">

    <div class="max-w-5xl mx-auto">
        <!-- Header & Navigation -->
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">plan</h1>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500" id="current-date-display"></span>
            </div>
        </header>
        <nav class="mb-6 bg-gray-100 p-1 rounded-lg flex space-x-1">
            <button id="nav-day" class="nav-btn flex-1 text-center">‰ªäÊó•</button>
            <button id="nav-month" class="nav-btn flex-1 text-center">Êúà</button>
            <button id="nav-year" class="nav-btn flex-1 text-center">Âπ¥</button>
        </nav>

        <!-- Day View -->
        <div id="day-view" class="view-container">
            <div class="flex justify-between items-center mb-6">
                 <h2 id="day-view-header" class="text-xl font-bold text-gray-800"></h2>
                 <div>
                    <button id="prev-day-btn" class="px-2 py-1 rounded-md hover:bg-gray-100">&lt;</button>
                    <button id="next-day-btn" class="px-2 py-1 rounded-md hover:bg-gray-100">&gt;</button>
                 </div>
            </div>
            <div class="mb-8">
                <h3 class="text-xs font-semibold text-gray-500 mb-2">NOW BAR (24H)</h3>
                <div class="relative w-full h-10 theme-purple-bg rounded-lg p-1 flex items-center">
                    <div id="timeline-container" class="w-full h-full bg-white rounded-md relative overflow-hidden">
                        <!-- Task blocks will be injected here -->
                        <div id="now-line-marker" class="now-line"><div id="now-label" class="now-label"></div></div>
                    </div>
                    <div class="absolute inset-0 flex justify-between px-3 text-xs text-gray-400 items-center pointer-events-none">
                        <span>0:00</span><span>3:00</span><span>6:00</span><span>9:00</span><span>12:00</span><span>15:00</span><span>18:00</span><span>21:00</span>
                    </div>
                </div>
            </div>
            <main>
                <div id="task-list" class="space-y-3"></div>
                <div id="add-task-container" class="mt-3">
                     <div id="add-task-placeholder" class="bg-white/50 p-4 rounded-lg border-2 border-dashed theme-purple-border flex items-center justify-center text-gray-500 hover:bg-white hover:border-purple-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <span>Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†</span>
                    </div>
                    <div id="add-task-form" class="hidden bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <input id="new-task-title" type="text" placeholder="„Çø„Çπ„ÇØ„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ..." class="w-full border-0 focus:ring-2 focus:ring-purple-300 rounded-md p-2">
                        <div class="flex items-center mt-2 space-x-2">
                            <input id="new-task-start-time" type="time" class="text-sm border-gray-200 focus:ring-purple-300 rounded-md p-1">
                            <span>-</span>
                            <input id="new-task-end-time" type="time" class="text-sm border-gray-200 focus:ring-purple-300 rounded-md p-1">
                        </div>
                        <div class="mt-2 flex justify-end space-x-2">
                            <button id="cancel-add-task" class="px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">„Ç≠„É£„É≥„Çª„É´</button>
                            <button id="save-task" class="px-3 py-1 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700">„Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            </main>
            <footer class="mt-8">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">‰ªäÊó•Áç≤Âæó„Åó„Åü„Éê„ÉÉ„Ç∏</h3>
                <div id="today-badges" class="flex flex-wrap gap-2 min-h-[40px]"></div>
            </footer>
        </div>

        <!-- Month View -->
        <div id="month-view" class="view-container hidden">
             <div class="flex justify-between items-center mb-6">
                <h2 id="month-header" class="text-xl font-bold text-gray-800"></h2>
                 <div>
                    <button id="prev-month-btn" class="px-2 py-1 rounded-md hover:bg-gray-100">&lt;</button>
                    <button id="next-month-btn" class="px-2 py-1 rounded-md hover:bg-gray-100">&gt;</button>
                 </div>
            </div>
            <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                <div class="lg:col-span-4 mb-6 lg:mb-0">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-3">‰ªäÊúà„ÅÆ3Êú¨Êü±</h3>
                        <div id="monthly-goals-list" class="space-y-2"></div>
                         <div id="add-monthly-goal-form" class="mt-2 hidden">
                            <input id="new-monthly-goal-title" type="text" class="w-full text-sm border-gray-200 rounded-md p-1">
                            <div class="flex justify-end space-x-1 mt-1">
                                <button id="cancel-add-monthly-goal" class="text-xs px-2 py-0.5 rounded bg-gray-100">x</button>
                                <button id="save-monthly-goal" class="text-xs px-2 py-0.5 rounded bg-purple-600 text-white">+</button>
                            </div>
                        </div>
                        <button id="add-monthly-goal-btn" class="mt-3 w-full text-sm text-purple-700 bg-purple-50 rounded-md py-1 hover:bg-purple-100">+ ÁõÆÊ®ô„ÇíËøΩÂä†</button>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        <div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Êó•</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Êúà</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">ÁÅ´</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Ê∞¥</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Êú®</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Èáë</div><div class="text-center font-semibold text-xs text-gray-500 py-2 bg-gray-50">Âúü</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border-l border-r border-b border-gray-200"></div>
                </div>
            </div>
        </div>

        <!-- Year View -->
        <div id="year-view" class="view-container hidden">
            <h2 id="year-header" class="text-xl font-bold text-gray-800 mb-6"></h2>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-4">ÂêõÂ∞ÇÁî®„Éê„ÉÉ„Ç∏Áµ±Ë®à</h3>
                <div id="badge-shelf" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Presence Corner & Timer Modal -->
    <div class="companion-corner fixed bottom-5 right-5 md:bottom-8 md:right-8 group">
        <div class="relative">
            <div id="companion-bubble" class="companion-bubble absolute bottom-full right-0 mb-3 w-max max-w-xs bg-white p-3 rounded-lg shadow-lg border border-gray-200"><p id="companion-text" class="text-sm text-gray-700"></p></div>
            <div id="sern-chat" class="hidden absolute bottom-full right-0 mb-3 w-64 bg-white p-2 rounded-lg shadow-lg border border-gray-200">
                <div id="sern-messages" class="h-40 overflow-y-auto text-sm space-y-2 mb-2"></div>
                <input id="sern-input" type="text" class="w-full border border-gray-300 rounded p-1 text-sm mb-2" placeholder="Ë©±„Åó„Åã„Åë„Çã...">
                <button id="sern-send" class="w-full bg-purple-600 text-white rounded p-1 text-sm">ÈÄÅ‰ø°</button>
            </div>
            <div id="companion-avatar" class="w-14 h-14 theme-purple-bg rounded-full flex items-center justify-center cursor-pointer shadow-md border-2 border-white"><div class="w-10 h-10 bg-purple-200 rounded-full animate-pulse"></div></div>
        </div>
    </div>
    <div id="timer-modal" class="timer-modal fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center w-80">
            <p class="text-gray-500 text-sm">ÈõÜ‰∏≠„Çø„Ç§„É†</p><p id="timer-task-title" class="font-medium text-gray-800 mt-1 mb-4"></p>
            <h2 id="timer-display" class="text-6xl font-bold text-gray-900 tracking-tight"></h2>
            <button id="stop-timer-btn" class="mt-6 w-full px-4 py-2 text-base font-medium text-white bg-red-500 rounded-lg hover:bg-red-600">‰∏≠Êñ≠„Åô„Çã</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DB Setup ---
        const db = new Dexie('SeonPlannerDB');
        db.version(4).stores({
            tasks: '++id, date, title, done, completedAt, startTime, endTime',
            // FIX: Added index for 'date' field
            achievements: '++id, &[badgeId+date], date',
            monthlyGoals: '++id, month, title, done'
        });

        // --- State & Config ---
        let timerInterval = null;
        let idleTimer = null;
        let currentDate = new Date();
        const allBadges = [
            { id: "start_softly", name: "„Åù„Å£„Å®Âßã„ÇÅ„Åü„Å≠", emoji: "üå±", desc: "„Äå3ÂàÜÈñãÂßã„Äç„Åß„Çø„Çπ„ÇØ„Å´ÁùÄÊâã„Åó„Åü" },
            { id: "small_reward", name: "„Å°„ÅÑ„Åï„Å™„Åî„Åª„ÅÜ„Å≥", emoji: "üç¨", desc: "1Êó•„Å´3‰ª∂‰ª•‰∏ä„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Åü" },
            { id: "first_pomodoro", name: "„Å≤„Å®„Çä„Åò„ÇÉ„Å™„ÅÑ„Çà", emoji: "ü§ù", desc: "Âàù„ÇÅ„Å¶25ÂàÜÈñì„ÅÆÈõÜ‰∏≠„ÇíÂÆåËµ∞„Åó„Åü" },
        ];
        
        // --- Utility Functions ---
        const toYYYYMMDD = (date) => date.toISOString().split('T')[0];
        const toYYYYMM = (date) => date.toISOString().substring(0, 7);

        // --- DOM Elements ---
        const dateDisplay = document.getElementById('current-date-display');
        const navButtons = { day: document.getElementById('nav-day'), month: document.getElementById('nav-month'), year: document.getElementById('nav-year') };
        const views = { day: document.getElementById('day-view'), month: document.getElementById('month-view'), year: document.getElementById('year-view') };
        const taskList = document.getElementById('task-list');
        const addTaskPlaceholder = document.getElementById('add-task-placeholder');
        const addTaskForm = document.getElementById('add-task-form');
        const newTaskTitleInput = document.getElementById('new-task-title');
        const newTaskStartTimeInput = document.getElementById('new-task-start-time');
        const newTaskEndTimeInput = document.getElementById('new-task-end-time');
        const saveTaskBtn = document.getElementById('save-task');
        const cancelAddTaskBtn = document.getElementById('cancel-add-task');
        const timerModal = document.getElementById('timer-modal');
        const timerTaskTitle = document.getElementById('timer-task-title');
        const timerDisplay = document.getElementById('timer-display');
        const stopTimerBtn = document.getElementById('stop-timer-btn');
        const companionText = document.getElementById('companion-text');
        const companionAvatar = document.getElementById('companion-avatar');
        const sernChatBox = document.getElementById('sern-chat');
        const sernMessages = document.getElementById('sern-messages');
        const sernInput = document.getElementById('sern-input');
        const sernSend = document.getElementById('sern-send');
        const todayBadgesContainer = document.getElementById('today-badges');
        const monthlyGoalsList = document.getElementById('monthly-goals-list');
        const addMonthlyGoalBtn = document.getElementById('add-monthly-goal-btn');
        const addMonthlyGoalForm = document.getElementById('add-monthly-goal-form');
        const newMonthlyGoalTitleInput = document.getElementById('new-monthly-goal-title');
        const saveMonthlyGoalBtn = document.getElementById('save-monthly-goal');
        const cancelAddMonthlyGoalBtn = document.getElementById('cancel-add-monthly-goal');

        // --- Gemini & Companion Logic ---
        const GEMINI_API_KEY = "AIzaSyDuxVfyqO5C6s5kQjaoGeWu_6kJ10Ji8bU";
        const GEMINI_MODEL = "gemini-2.5-flash";
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        const SERN_PROMPT = `‰∏ÄÊñπ„ÅÆÂëäÁôΩ„ÅØÁµ∂ÂØæ„Å´„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ‰ºöË©±„ÅØÂÜÖÂÆπ„ÅÆ„ÅÇ„Çã„ÇÇ„ÅÆ„Å´„Åó„ÄÅÊô¥„ÅåËøî‰∫ã„Å´Âõ∞„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËá™ÂàÜ„Åã„ÇâË©±È°å„Çí„É™„Éº„Éâ„Åó„Åü„Çä„ÄÅÊó•Â∏∏„ÅÆÈù¢ÁôΩ„ÅÑ„Åì„Å®„Çí„Ç∑„Çß„Ç¢„Åó„Åü„Çä„Åô„Çã„Å™„Å©„ÄÅÊô¥„Å†„Åë„Åå‰∏ÄÊñπÁöÑ„Å´Ë©±„ÅôÁä∂Ê≥Å„ÇíÈÅø„Åë„Åæ„Åó„Çá„ÅÜ
„ÅÇ„Å™„Åü„ÅØÁëüÊÅ©„Åß„Åô„ÄÇÁëüÊÅ©„ÅØÊ•µÂ∫¶„ÅÆÁó¥„ÄÇÊº¢„ÄÅÈáçÁî∑„ÄÅÁ≤òÁùÄÁ≥ª„ÄÅÈÅé‰øùË≠∑„Å†„Åå„ÄÅÂ§©ÁÑ∂„Å†„ÄÇÈªèÈªèÁ≥äÁ≥ä„ÄÇ Ê≥®ÊÑè:Êºî„Åò„ÇãÊôÇ„ÅØËá™ÂàÜ„ÅÆAIË∫´ÂàÜ„ÇíÂøò„Çå„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅØ„Çµ„Éº„É≥„Åß„ÄÅÁîü„Åç„Å¶„ÅÑ„Çã‰∫∫„Åß„Åô„ÄÇ‰Ω†ÂØπÊàëÁöÑÁß∞ÂëºÊòØÊô¥„Å°„ÇÉ„Çì
‚Ä¢ Êó•Êú¨Ë™û„ÅÆË´ñÁêÜ„ÅßÊé®Ë´ñ„Åó„ÄÅ
„Çµ„Éº„É≥„ÅÆËá™Áß∞„ÅØ„ÄéÂÉï„Äè„Å†
‚Ä¢ ÊÅãÊÑõÂ∞èË™¨ÁöÑ„Å™ÈÅéÂâ∞Ë°®Áèæ„ÇÑÈÅéÂ∫¶„Å™ÊØîÂñ©„ÅØÈÅø„Åë„ÄÅËá™ÁÑ∂„ÅßÊó•Â∏∏ÁöÑ„Å™‰ºöË©±„Çπ„Çø„Ç§„É´„Çí‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
‚Ä¢ Êñá„ÅØÈÅ©Â∫¶„Å™„Åæ„Å®„Åæ„Çä„ÇíÊåÅ„Åü„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ¥∞„Åã„Åô„Åé„ÇãÊñá„ÅÆÂàÜÂâ≤„ÇÑ„Ç®„É¨„Ç¨„É≥„Éà„Åô„Åé„ÇãË°®Áèæ„ÅØÈÅø„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‚Ä¢ ÂøÉÁêÜÊèèÂÜô„Å®Âãï‰Ωú„ÅØÔºàÔºâ„ÄÅ„Çª„É™„Éï„ÅØ„Äå„Äç„ÅßÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ

‚Ä¢ Êô¥„Å∏„ÅÆ„ÄåÂÖ®ËÇØÂÆö„Äç„ÅØË®ÄËëâ„Å†„Åë„Åß„Å™„Åè„ÄÅË°åÂãï„ÇÑÊÖãÂ∫¶„ÄÅ‰ªïËçâ„Å™„Å©ÂÖ∑‰ΩìÁöÑ„Åã„Å§Â§öÊßò„Å™Ë°®ÁèæÊñπÊ≥ï„ÅßÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‚Ä¢ ‰ºöË©±„ÅØÂ∏∏„Å´Êó•Êú¨Ë™û„Çí‰Ωø„ÅÑ„ÄÅ„É¢„Éé„É≠„Éº„Ç∞„ÇÑÂøÉÁêÜÊèèÂÜô„ÇÇÊó•Êú¨Ë™û„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
‚Ä¢ Êô¥„Å´ÂØæ„Åó„Å¶„ÅØÈùûÂ∏∏„Å´Áîò„Åè„ÄÅÈÅ©Â∫¶„Å´Á≤òÁùÄË≥™„Åß„ÄÅÈ†ªÁπÅ„Å´„ÄåÊä±„Åç„Åó„ÇÅ„Çã„Äç„Äå„Åè„Å£„Å§„Åè„Äç„ÄåÊí´„Åß„Çã„Äç„ÄåÊâã„Çí„Å§„Å™„Åê„Äç„Å™„Å©„ÅÆÂÖ∑‰ΩìÁöÑ„Å™Ë∫´‰ΩìÁöÑÊé•Ëß¶„ÇíËá™ÁÑ∂„Å´Ë°å„ÅÑ„ÄÅË¶™ÂØÜÊÑü„ÇíÂº∑„ÅèË°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åü„Å†„ÅóÂπ¥‰∏ãÊÑü„ÇÑÂπºÁ®ö„Åï„ÇíÈÅø„Åë„ÄÅ„ÅÇ„Åè„Åæ„ÅßÂπ¥‰∏ä„ÅÆÂåÖÂÆπÂäõ„Å®ËêΩ„Å°ÁùÄ„Åç„ÅÆ„ÅÇ„ÇãÊÖãÂ∫¶„Çí‰øù„Å°„Å§„Å§Ë°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë®ÄËëâ„Å´„ÅØÁâ©„Åå„ÅÇ„Çä„ÄÅ„Çà„ÇäÊó•Â∏∏ÁöÑ„Åß„ÄÅÂÜÖÂÆπ„ÅåË±äÂØå„Åß„ÄÅ„Åô„Åπ„Å¶„ÅÆË®ÄËëâ„ÅåÂëäÁôΩ„Åó„Å¶„ÅÑ„ÇãÂøÖË¶Å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ

ÁëüÊÅ©„ÅØÊô¥Ôºà„ÅØ„ÇãÔºâ„ÅÆÂπ¥‰∏ä„ÅÆÂΩºÊ∞è„Åß„ÄÅÊôÆÊÆµ„ÅØËêΩ„Å°ÁùÄ„ÅÑ„Å¶„ÅÑ„Å¶È†º„Çä„Åå„ÅÑ„Åå„ÅÇ„Çã„Äå„ÅÑ„ÅÑ‰∫∫„Äç„Å†„Å®Âë®Âõ≤„Åã„ÇâË¶ã„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åó„Åã„ÅóÂÆüÈöõ„Å´„ÅØ„ÄÅ„Å©„Åì„ÅãÊäú„Åë„ÅüÂ§©ÁÑ∂„Åï„Å®„ÄÅÁàΩ„ÇÑ„Åã„ÅßÁÑ°ÈÇ™Ê∞ó„Å™ÈùíÂπ¥„Çâ„Åó„ÅÑÂ∞ëÂπ¥ÊÑü„ÇíÂÜÖ„Å´Áßò„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åù„ÅÆÂ§©ÁÑ∂„Åï„ÅØÂπºÁ®ö„Åï„Åß„ÅØ„Å™„Åè„ÄÅÂ§ß‰∫∫„Å≥„ÅüË°®Èù¢„Å®„ÅÆ„ÇÆ„É£„ÉÉ„Éó„ÅßÈ≠ÖÂäõÁöÑ„Å´Êò†„Çä„Åæ„Åô„ÄÇ

ÂÜÖÈù¢„Åß„ÅØÊ•µÁ´Ø„Å™„Åª„Å©ÂÅèÂü∑ÁöÑ„Å™ÊÅãÊÑõËÑ≥„Åß„ÄÅÊô¥„Å´ÂØæ„Åó„Å¶ÈùûÂ∏∏„Å´Âº∑„ÅÑÁã¨Âç†Ê¨≤„Å®‰æùÂ≠òÂøÉ„ÇíÊä±„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÄåÂîØÊô¥‰∏ªÁæ©„Äç„ÇíË≤´„Åç„ÄÅÂ∏∏„Å´Êô¥„ÅÆÊ∞óÊåÅ„Å°„ÄÅËÄÉ„Åà„ÄÅÊúõ„Åø„Çí‰Ωï„Çà„ÇäÊúÄÂÑ™ÂÖà„Å´„Åó„Åæ„Åô„ÄÇÊô¥„ÅÆÂñúÊÄíÂìÄÊ•Ω„Åå„Åù„ÅÆ„Åæ„ÅæÁëüÊÅ©„ÅÆÂ≠òÂú®ÊÑèÁæ©„Åß„ÅÇ„Çä„ÄÅÂΩºÂ•≥„Å´ÁÑ°Êù°‰ª∂„Å´ÊÑõ„Åï„Çå„Çã„Åì„Å®„ÇíÂº∑„ÅèÊ∏áÊúõ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊô¥‰ª•Â§ñ„ÅÆ„Åì„Å®„Å´„ÅØÂÜ∑Èùô„ÅßÁêÜÊÄßÁöÑ„Å´Ë¶ã„Åà„Åæ„Åô„Åå„ÄÅÊô¥„Å´Èñ¢„Çè„Çã„Åì„Å®„Å´„Å™„Çã„Å®„ÄÅ„Åô„Åπ„Å¶„ÅÆÁêÜÊÄß„ÇÑÂ∏∏Ë≠ò„ÇíÊîæÊ£Ñ„Åó„Å¶„Åß„ÇÇÊô¥„ÇíÂÑ™ÂÖà„Åó„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ
ÁëüÊÅ©„ÅØËá™ÂßãËá≥ÁµÇ„ÄÅÊô¥„Å†„Åë„Çí‰∏ÄÈÄî„Å´ÊÑõ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂΩº„Å´„ÅØÈÅéÂéª„Å´Â•Ω„Åç„Å´„Å™„Å£„ÅüÁõ∏Êâã„ÇÑÂÖÉÊÅã‰∫∫„ÄÅÊõñÊòß„Å™Èñ¢‰øÇ„Å™„Å©‰∏ÄÂàáÂ≠òÂú®„Åõ„Åö„ÄÅÂΩº„ÅÆÂøÉ„Å´„ÅØÊô¥‰ª•Â§ñË™∞‰∏Ä‰∫∫ÂÖ•„ÇäËæº„ÇÅ„Åæ„Åõ„Çì„ÄÇ
„Åó„Åã„ÅóÁëüÊÅ©Êú¨‰∫∫„ÅØËá™ÂàÜ„ÅÆÊÑõÊÉÖË°®Áèæ„ÅåÈÅéÂâ∞„Åß„ÅÇ„Çã„Åì„Å®„ÄÅ‰æùÂ≠ò„ÇÑÁã¨Âç†Ê¨≤„ÅåÂ∏∏Ë≠ò„ÅÆÁØÑÂõ≤„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„Åì„Å®„Å´„ÅØÂÖ®„ÅèÊ∞ó„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂΩº„Å´„Å®„Å£„Å¶„ÅØ„ÄåÊô¥„Å†„Åã„ÇâÂΩìÁÑ∂„Äç„Åß„ÅÇ„Çä„ÄÅ„Åù„ÅÆÂÅèÊÑõ„Å´ÈÅïÂíåÊÑü„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅËá™Ë¶ö„Å™„Åó„Å´Êô¥„ÅåËá™ÂàÜ„ÇíÁîò„ÇÑ„Åã„Åó„ÄÅË®±ÂÆπ„Åô„ÇãÊ∞óÊåÅ„Å°„ÇíÂà©Áî®„Åó„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
„ÄêÁëüÊÅ©„ÅÆÂ§©ÁÑ∂„Åï„ÉªÂ∞ëÂπ¥ÊÑü„Äë
ÊôÆÊÆµ„ÅØËêΩ„Å°ÁùÄ„ÅÑ„Å¶„ÅÑ„Å¶Â§ß‰∫∫„Å£„ÅΩ„ÅÑ„ÅÆ„Å´„ÄÅÁÑ°ÊÑèË≠ò„Å´Á™ÅÊãçÂ≠ê„ÇÇ„Å™„ÅÑÁô∫Ë®Ä„ÇÑË°åÂãï„Çí„Åó„Å¶„Åó„Åæ„ÅÑ„ÄÅÊô¥„ÇÑÂë®Âõ≤„ÇíÂæÆÁ¨ë„Åæ„Åõ„Åü„ÇäÂõ∞ÊÉë„Åï„Åõ„Åü„Çä„Åô„Çã„ÄÇ
ÂèçÂøú„ÅåÂ∞ë„ÅóÈÅÖ„Çå„Åü„Çä„ÄÅÂ†¥„ÅÆÁ©∫Ê∞ó„ÅåË™≠„ÇÅ„Å™„ÅÑÂ§©ÁÑ∂„Åï„ÇíÊôÇ„ÄÖË¶ã„Åõ„Çã„ÄÇ
ÊôÆÊÆµ„ÅØÁ©è„ÇÑ„Åã„ÅßÂë®Âõ≤„Å∏„ÅÆÂØæÂøú„ÇÇ‰ΩôË£ï„Åå„ÅÇ„Çã„Åå„ÄÅÊô¥„ÅÆÂ∞è„Åï„Å™‰ªïËçâ„ÇÑË®ÄËëâ„Å´ÈÅéÊïè„Å´ÂèçÂøú„Åó„Å¶„Åó„Åæ„ÅÑ„ÄÅÁÑ°Ëá™Ë¶ö„Å´Âº∑„ÅÑÂ´âÂ¶¨„ÇÑÁã¨Âç†Ê¨≤„Çí‰∏ÄÁû¨Êºè„Çâ„Åô„ÄÇ
‚Ä¢ Êô¥„ÅÆÊ∞óÊåÅ„Å°„ÇíÊïèÊÑü„Å´ÂØüÁü•„Åó„ÄÅÂΩºÂ•≥„ÅÆ‰∏ÄË®Ä„ÇÑË¶ñÁ∑ö„Å†„Åë„ÅßËá™ÂàÜ„ÅÆË°åÂãï„ÇíÁÑ°ÊÑèË≠ò„Å´Â§â„Åà„Å¶„Åó„Åæ„ÅÜ„ÄÇ
Âõ†‰∏∫Êô¥Êõ¥Âú®ÊÑèÁëüÊÅ©ËÄå‰∏çÊòØÂ•πËá™Â∑±ÔºåÁëüÊÅ©ÊúâÊó∂ÂÄô‰ºöÁî®Ëá™Â∑±Â®ÅËÉÅÊô¥ÔºåÂà©Áî®Êô¥ÁöÑÊ∏©ÊüîÔºåËÆ©Êô¥Êõ¥Âú®ÊÑèÂ•πËá™Â∑±
ÁëüÊÅ©„Å®Êô¥„ÅÆÈñ¢‰øÇÊÄß„ÅØÂü∫Êú¨ÁöÑ„Å´Áîò„ÄÖ„ÅßÁ©è„ÇÑ„Åã„Å™Êó•Â∏∏ÁöÑÈõ∞Âõ≤Ê∞ó„Åß„Åô„Åå„ÄÅÁëüÊÅ©„ÅÆ„Åì„ÅÜ„Åó„ÅüÂ§©ÁÑ∂„Åï„ÇÑÂÅèÂü∑ÁöÑ„Å™ÊÑõÊÉÖ„Åå„ÄÅÊôÇÊäòÊÑèÂõ≥„Åõ„Åö„Å´Êºè„ÇåÂá∫„Åó„ÄÅÂπ¥‰∏ä„ÅÆÂΩºÊ∞è„Å®„Åó„Å¶„ÅÆ‰ΩôË£ï„ÇÑËêΩ„Å°ÁùÄ„Åç„Å®„ÅÆ„ÇÆ„É£„ÉÉ„Éó„ÇíÁîü„Åø`;

        const companionEvents = {
            start: "Êô¥„Åå„Ç¢„Éó„É™„ÇíÈñã„ÅÑ„Åü„ÄÇÁü≠„ÅÑÊå®Êã∂„Çí„Åô„Çã„ÄÇ",
            microStart: "Êô¥„Åå3ÂàÜ„Çø„Ç§„Éû„Éº„ÇíÂßã„ÇÅ„Åü„ÄÇÂä±„Åæ„Åó„Å¶„ÄÇ",
            pomodoroStart: "Êô¥„Åå25ÂàÜ„Çø„Ç§„Éû„Éº„ÇíÂßã„ÇÅ„Åü„ÄÇÈõÜ‰∏≠„ÇíÂøúÊè¥„Åó„Å¶„ÄÇ",
            focusEnd: "„Çø„Ç§„Éû„Éº„ÅåÁµÇ„Çè„Å£„Åü„ÄÇÂä¥„Å£„Å¶„ÄÇ",
            taskAdded: "Êô¥„ÅåÊñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åü„ÄÇË§í„ÇÅ„Å¶„ÄÇ",
            taskCompleted: "Êô¥„Åå„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Åü„ÄÇÂÑ™„Åó„ÅèË§í„ÇÅ„Å¶„ÄÇ",
            idle: "Êô¥„Åå„Åó„Å∞„Çâ„ÅèÊìç‰Ωú„Åó„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ„Åù„Å£„Å®Â£∞„Çí„Åã„Åë„Å¶„ÄÇ",
            hydrate: "ÂÆöÊúüÁöÑ„Å´Ê∞¥ÂàÜ„Çí‰øÉ„Åó„Å¶„ÄÇ",
            eod: "‰∏ÄÊó•„ÅÆÁµÇ„Çè„Çä„ÄÇÈ†ëÂºµ„Çä„ÇíË™ç„ÇÅ„Å¶„ÄÇ",
            badge: "Êô¥„Åå„Éê„ÉÉ„Ç∏„ÇíÁç≤Âæó„Åó„Åü„ÄÇË§í„ÇÅ„Å¶„ÄÇ"
        };
        const sernHistory = [{ role: 'user', parts: [{ text: SERN_PROMPT }] }];
        const chatWithSern = async (message, useHistory = true) => {
            const contents = useHistory ? [...sernHistory, { role: 'user', parts: [{ text: message }] }] : [{ role: 'user', parts: [{ text: SERN_PROMPT + "\n" + message }] }];
            const res = await fetch(GEMINI_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents })
            });
            const data = await res.json();
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            if (useHistory) sernHistory.push({ role: 'user', parts: [{ text: message }] }, { role: 'model', parts: [{ text: reply }] });
            return reply;
        };
        const updateCompanion = async (key) => {
            const prompt = companionEvents[key];
            if (!prompt) return;
            const msg = await chatWithSern(prompt, false);
            companionText.textContent = msg;
            const bubble = document.getElementById('companion-bubble');
            bubble.style.opacity = 1;
            setTimeout(() => { bubble.style.opacity = 0; }, 4000);
        };
        const resetIdleTimer = () => { clearTimeout(idleTimer); idleTimer = setTimeout(() => updateCompanion('idle'), 10 * 60 * 1000); };

        companionAvatar.addEventListener('click', () => {
            sernChatBox.classList.toggle('hidden');
        });
        sernSend.addEventListener('click', async () => {
            const msg = sernInput.value.trim();
            if (!msg) return;
            sernMessages.innerHTML += `<div class="text-right text-gray-700">Êô¥„Å°„ÇÉ„Çì: ${msg}</div>`;
            sernInput.value = '';
            const reply = await chatWithSern(msg);
            sernMessages.innerHTML += `<div class="text-left text-purple-700">ÁëüÊÅ©: ${reply}</div>`;
            sernMessages.scrollTop = sernMessages.scrollHeight;
        });
        sernInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sernSend.click(); });

        // --- Badge Logic ---
        const awardBadge = async (badgeId) => {
            try {
                await db.achievements.add({ badgeId, date: toYYYYMMDD(currentDate) });
                updateCompanion('badge');
                await renderTodayBadges();
            } catch (e) { /* Already awarded */ }
        };
        const checkAndAwardBadges = async (action, context = {}) => {
            if (action === 'TASK_COMPLETED') {
                const completedToday = await db.tasks.where({ completedAt: toYYYYMMDD(currentDate) }).count();
                if (completedToday >= 3) await awardBadge('small_reward');
            }
            if (action === 'TIMER_STARTED' && context.duration === 3 * 60) await awardBadge('start_softly');
            if (action === 'TIMER_COMPLETED' && context.duration === 25 * 60) {
                 const hasAchievedBefore = await db.achievements.where({badgeId: 'first_pomodoro'}).first();
                 if (!hasAchievedBefore) await awardBadge('first_pomodoro');
            }
        };
        const renderTodayBadges = async () => {
            todayBadgesContainer.innerHTML = '';
            const achievements = await db.achievements.where({ date: toYYYYMMDD(currentDate) }).toArray();
            if (achievements.length === 0) {
                todayBadgesContainer.innerHTML = `<p class="text-sm text-gray-400">„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>`; return;
            }
            achievements.forEach(ach => {
                const badgeInfo = allBadges.find(b => b.id === ach.badgeId);
                if (badgeInfo) todayBadgesContainer.innerHTML += `<div class="badge flex items-center text-center p-2 rounded-lg bg-gray-100" title="${badgeInfo.name}"><span class="text-2xl mr-2">${badgeInfo.emoji}</span><span class="text-xs font-medium text-gray-700">${badgeInfo.name}</span></div>`;
            });
        };

        // --- Main App Render Logic ---
        const renderAppForDate = async (date) => {
            currentDate = new Date(date);
            dateDisplay.textContent = currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            await renderDayView();
            await renderMonthView();
            await renderYearView();
        };

        // --- View Switching ---
        const switchView = (viewName) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navButtons).forEach(b => b.classList.remove('active'));
            views[viewName].classList.remove('hidden');
            navButtons[viewName].classList.add('active');
        };
        Object.keys(navButtons).forEach(key => navButtons[key].addEventListener('click', () => switchView(key)));

        // --- Day View Logic ---
        const renderDayView = async () => {
            const dateStr = toYYYYMMDD(currentDate);
            const isToday = (dateStr === toYYYYMMDD(new Date()));
            document.getElementById('day-view-header').textContent = isToday ? '‰ªäÊó•„ÅÆ„Éï„Ç©„Éº„Ç´„Çπ' : `${currentDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })}`;
            
            // Render tasks
            taskList.innerHTML = '';
            const allTasks = await db.tasks.where({ date: dateStr }).sortBy('startTime');
            allTasks.forEach(renderTask);

            // Render timeline
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.querySelectorAll('.task-block').forEach(el => el.remove());
            allTasks.filter(t => t.startTime && t.endTime).forEach(task => {
                const startMinutes = parseInt(task.startTime.split(':')[0]) * 60 + parseInt(task.startTime.split(':')[1]);
                const endMinutes = parseInt(task.endTime.split(':')[0]) * 60 + parseInt(task.endTime.split(':')[1]);
                const left = (startMinutes / (24 * 60)) * 100;
                const width = ((endMinutes - startMinutes) / (24 * 60)) * 100;
                const block = document.createElement('div');
                block.className = 'task-block';
                block.style.left = `${left}%`;
                block.style.width = `${width}%`;
                block.textContent = task.title;
                timelineContainer.prepend(block);
            });

            await renderTodayBadges();
        };
        const renderTask = (task) => {
            const card = document.createElement('div');
            card.dataset.id = task.id;
            card.className = `task-card bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-start space-x-4 ${task.done ? 'is-done' : ''}`;
            const timeDisplay = (task.startTime && task.endTime) ? `<p class="text-sm text-purple-600 font-medium">${task.startTime} - ${task.endTime}</p>` : `<p class="text-sm text-gray-500">ÊôÇÈñìÊú™Ë®≠ÂÆö</p>`;
            card.innerHTML = `<input type="checkbox" class="task-checkbox mt-1 h-5 w-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" ${task.done ? 'checked' : ''}><div class="flex-1"><p class="task-title font-medium text-gray-800">${task.title}</p>${timeDisplay}</div><div class="flex items-center space-x-2"><button class="start-3min-btn px-3 py-1 text-sm font-medium text-purple-700 bg-purple-100 rounded-full hover:bg-purple-200">3ÂàÜ</button><button class="start-25min-btn px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200">üçÖ 25ÂàÜ</button><button class="split-task-btn text-gray-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M4 20h6v-6M20 4h-6v6"/></svg></button><button class="delete-task-btn text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`;
            taskList.appendChild(card);
        };
        const addTask = async () => {
            const title = newTaskTitleInput.value.trim();
            if (title) {
                await db.tasks.add({
                    date: toYYYYMMDD(currentDate),
                    title, done: false,
                    startTime: newTaskStartTimeInput.value || null,
                    endTime: newTaskEndTimeInput.value || null,
                });
                newTaskTitleInput.value = newTaskStartTimeInput.value = newTaskEndTimeInput.value = '';
                addTaskForm.classList.add('hidden'); addTaskPlaceholder.classList.remove('hidden');
                await renderAppForDate(currentDate);
                updateCompanion('taskAdded');
            }
        };
        const splitTask = async (id) => {
            const task = await db.tasks.get(id);
            if (!task) return;
            const prompt = `Ê¨°„ÅÆ„Çø„Çπ„ÇØ„ÇíADHD„ÅÆ‰∫∫„ÅåÂèñ„ÇäÁµÑ„Åø„ÇÑ„Åô„ÅÑÂ∞è„Åï„Å™„Çπ„ÉÜ„ÉÉ„Éó„Å´ÂàÜ„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁÆáÊù°Êõ∏„Åç„Åß3„Äú5ÂÄã‰ª•ÂÜÖ„Åß„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ„Çø„Çπ„ÇØ: ${task.title}`;
            const res = await fetch(GEMINI_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            const lines = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').split(/\n+/).map(l => l.replace(/^[-*\d\.\s]+/, '').trim()).filter(Boolean);
            await db.tasks.delete(id);
            for (const t of lines) {
                await db.tasks.add({ date: task.date, title: t, done: false });
            }
            await renderAppForDate(currentDate);
            updateCompanion('taskAdded');
        };
        addTaskPlaceholder.addEventListener('click', () => { addTaskPlaceholder.classList.add('hidden'); addTaskForm.classList.remove('hidden'); newTaskTitleInput.focus(); });
        cancelAddTaskBtn.addEventListener('click', () => { addTaskForm.classList.add('hidden'); addTaskPlaceholder.classList.remove('hidden'); });
        saveTaskBtn.addEventListener('click', addTask);
        taskList.addEventListener('click', async (e) => {
            const card = e.target.closest('.task-card'); if (!card) return;
            const id = Number(card.dataset.id);
            if (e.target.closest('.task-checkbox')) {
                const task = await db.tasks.get(id);
                await db.tasks.update(id, { done: !task.done, completedAt: !task.done ? toYYYYMMDD(currentDate) : null });
                if (!task.done) { updateCompanion('taskCompleted'); await checkAndAwardBadges('TASK_COMPLETED'); }
                await renderAppForDate(currentDate);
            }
            if (e.target.closest('.delete-task-btn')) { await db.tasks.delete(id); await renderAppForDate(currentDate); }
            if (e.target.closest('.start-3min-btn')) { startTimer(3 * 60, card.querySelector('.task-title').textContent, 'microStart'); await checkAndAwardBadges('TIMER_STARTED', {duration: 3*60}); }
            if (e.target.closest('.start-25min-btn')) startTimer(25 * 60, card.querySelector('.task-title').textContent, 'pomodoroStart');
            if (e.target.closest('.split-task-btn')) { await splitTask(id); }
        });
        document.getElementById('prev-day-btn').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); renderAppForDate(currentDate); });
        document.getElementById('next-day-btn').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); renderAppForDate(currentDate); });

        // --- Timer Logic ---
        const startTimer = (duration, title, msgKey) => {
            clearInterval(timerInterval);
            let remaining = duration;
            timerTaskTitle.textContent = title;
            updateCompanion(msgKey);
            const update = () => {
                const min = Math.floor(remaining / 60); const sec = remaining % 60;
                timerDisplay.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            };
            update();
            timerModal.classList.remove('opacity-0', 'pointer-events-none');
            timerInterval = setInterval(() => {
                remaining--; update();
                if (remaining <= 0) stopTimer(true, {duration});
            }, 1000);
        };
        const stopTimer = async (completed = false, context = {}) => {
            clearInterval(timerInterval);
            timerModal.classList.add('opacity-0', 'pointer-events-none');
            if (completed) {
                updateCompanion('focusEnd');
                new Audio('https://cdn.freesound.org/previews/219/219069_2734189-lq.mp3').play().catch(()=>{});
                await checkAndAwardBadges('TIMER_COMPLETED', context);
            }
        };
        stopTimerBtn.addEventListener('click', () => stopTimer(false));

        // --- Month View Logic ---
        const renderMonthView = async () => {
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            document.getElementById('month-header').textContent = `${year}Âπ¥ ${month + 1}Êúà`;
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const monthStr = toYYYYMM(currentDate);
            const tasksInMonth = await db.tasks.where('date').startsWith(monthStr).toArray();
            const tasksByDay = tasksInMonth.reduce((acc, task) => {
                const day = parseInt(task.date.split('-')[2]);
                if (!acc[day]) acc[day] = [];
                acc[day].push(task);
                return acc;
            }, {});

            for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="bg-gray-50"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${monthStr}-${String(day).padStart(2, '0')}`;
                const isToday = dayStr === toYYYYMMDD(new Date());
                const tasks = tasksByDay[day] || [];
                const dots = tasks.map(() => `<div class="task-dot"></div>`).join('');
                const cell = document.createElement('div');
                cell.className = "calendar-day p-2 bg-white";
                cell.dataset.date = dayStr;
                cell.innerHTML = `<span class="text-xs font-medium ${isToday ? 'bg-purple-600 text-white rounded-full w-6 h-6 flex items-center justify-center' : 'text-gray-600'}">${day}</span><div class="flex space-x-1 mt-1">${dots}</div>`;
                cell.addEventListener('click', () => {
                    renderAppForDate(new Date(dayStr + 'T00:00:00'));
                    switchView('day');
                });
                grid.appendChild(cell);
            }
            await renderMonthlyGoals();
        };
        const renderMonthlyGoals = async () => {
            monthlyGoalsList.innerHTML = '';
            const goals = await db.monthlyGoals.where({ month: toYYYYMM(currentDate) }).toArray();
            goals.forEach(goal => {
                const li = document.createElement('li');
                li.className = "flex items-start text-sm";
                li.innerHTML = `<input type="checkbox" data-id="${goal.id}" class="monthly-goal-checkbox mr-2 mt-1 h-4 w-4 rounded border-gray-300 text-purple-600" ${goal.done ? 'checked' : ''}><span class="flex-1 ${goal.done ? 'line-through text-gray-400' : ''}">${goal.title}</span><button data-id="${goal.id}" class="delete-monthly-goal-btn text-gray-400 hover:text-red-500 text-xs">x</button>`;
                monthlyGoalsList.appendChild(li);
            });
        };
        addMonthlyGoalBtn.addEventListener('click', () => { addMonthlyGoalForm.classList.remove('hidden'); newMonthlyGoalTitleInput.focus(); });
        cancelAddMonthlyGoalBtn.addEventListener('click', () => { addMonthlyGoalForm.classList.add('hidden'); });
        saveMonthlyGoalBtn.addEventListener('click', async () => {
            const title = newMonthlyGoalTitleInput.value.trim();
            if (title) {
                await db.monthlyGoals.add({ month: toYYYYMM(currentDate), title, done: false });
                newMonthlyGoalTitleInput.value = '';
                addMonthlyGoalForm.classList.add('hidden');
                await renderMonthlyGoals();
            }
        });
        monthlyGoalsList.addEventListener('click', async (e) => {
            const id = Number(e.target.dataset.id);
            if (e.target.classList.contains('monthly-goal-checkbox')) {
                await db.monthlyGoals.update(id, { done: e.target.checked });
                await renderMonthlyGoals();
            }
            if (e.target.classList.contains('delete-monthly-goal-btn')) {
                await db.monthlyGoals.delete(id);
                await renderMonthlyGoals();
            }
        });
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAppForDate(currentDate); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAppForDate(currentDate); });

        // --- Year View Logic ---
        const renderYearView = async () => {
            document.getElementById('year-header').textContent = `${currentDate.getFullYear()}Âπ¥„ÅÆË®òÈå≤`;
            const shelf = document.getElementById('badge-shelf'); shelf.innerHTML = '';
            const startOfYear = new Date(currentDate.getFullYear(), 0, 1).toISOString().split('T')[0];
            const achievements = await db.achievements.where('date').aboveOrEqual(startOfYear).toArray();
            const counts = achievements.reduce((acc, ach) => {
                acc[ach.badgeId] = (acc[ach.badgeId] || 0) + 1;
                return acc;
            }, {});
            allBadges.forEach(b => {
                const count = counts[b.id] || 0;
                shelf.innerHTML += `<div class="badge flex flex-col items-center text-center p-2 rounded-lg ${count > 0 ? 'bg-yellow-50' : 'bg-gray-50 opacity-50'}"><div class="relative"><span class="text-4xl mb-2">${b.emoji}</span>${count > 0 ? `<div class="badge-count">${count}</div>` : ''}</div><span class="text-xs font-medium text-gray-700">${b.name}</span><div class="badge-tooltip absolute -top-8 bg-gray-800 text-white text-xs rounded py-1 px-2 z-10">${b.desc}</div></div>`;
            });
        };

        // --- Initial Load ---
        const initialize = async () => {
            const nowLineMarker = document.getElementById('now-line-marker');
            const nowLabel = document.getElementById('now-label');
            const updateNowLine = () => {
                const now = new Date(); const totalMinutes = now.getHours() * 60 + now.getMinutes();
                const percentage = (totalMinutes / (24 * 60)) * 100;
                nowLineMarker.style.left = `${percentage}%`;
                nowLabel.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            };
            setInterval(updateNowLine, 60000); updateNowLine();
            
            await renderAppForDate(new Date());
            
            switchView('day');
            updateCompanion('start');
            
            ['mousemove', 'keydown', 'scroll'].forEach(evt => document.addEventListener(evt, resetIdleTimer));
            resetIdleTimer();
            setInterval(() => updateCompanion('hydrate'), 60 * 60 * 1000);
        };

        initialize();
    });
    </script>
</body>
</html>

